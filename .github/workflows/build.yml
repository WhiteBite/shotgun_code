name: Crossâ€‘platform Build + Release â€” Shotgun Code

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Linux â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - os: ubuntu-latest
            platform: linux/amd64
            build_name: shotgun-code-linux-amd64
            artifact_name: shotgun_code-linux-amd64
            package: false
            artifact_path: build/bin/shotgun-code-linux-amd64

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Windows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - os: windows-latest
            platform: windows/amd64
            build_name: shotgun-code-windows-amd64.exe
            artifact_name: shotgun_code-windows-amd64
            package: false
            artifact_path: build/bin/shotgun-code-windows-amd64.exe

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ macOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - os: macos-latest
            platform: darwin/arm64
            build_name: shotgun-code # .app
            artifact_name: shotgun_code-darwin-arm64
            package: true
            artifact_path: build/bin/shotgun-code.app.zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run Frontend Tests
        working-directory: ./frontend
        run: |
          npm run test:run

      - name: Generate Coverage Report
        working-directory: ./frontend
        run: |
          npm run test:run -- --coverage

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: backend/go.sum

      - name: Run Backend Tests
        working-directory: ./backend
        run: |
          go test $(go list ./... | grep -vE '^shotgun_code$|/cmd/') -short -count=1

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: backend
          args: --config .golangci.yml --timeout 5m
          skip-cache: false

      - name: Get version info
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="v$(date -u '+%Y.%m.%d')-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "date=$(date -u '+%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Build Wails app (${{ matrix.platform }})
        uses: dAppServer/wails-build-action@main
        with:
          build-name: ${{ matrix.build_name }}
          build-platform: ${{ matrix.platform }}
          go-version: "1.24"
          package: ${{ matrix.package }}
          ldflags: "-X shotgun_code/infrastructure/version.Version=${{ steps.version.outputs.version }} -X shotgun_code/infrastructure/version.GitCommit=${{ steps.version.outputs.commit }} -X shotgun_code/infrastructure/version.BuildDate=${{ steps.version.outputs.date }}"

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RELEASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    needs: build
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout for tag info
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: shotgun_code-*
          path: release-assets
          fail_on_no_artifact: true

      - name: Prepare tag & release metadata
        id: prep
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="v$(date -u '+%Y.%m.%d')-${GITHUB_SHA::7}"
          fi
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT
          echo "release_name=Shotgun Code $TAG" >> $GITHUB_OUTPUT

      - name: Get changelog from tag annotation
        id: changelog
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG_MSG=$(git tag -l --format='%(contents)' "${{ github.ref_name }}" 2>/dev/null || echo "")
            if [ -n "$TAG_MSG" ] && [ "$TAG_MSG" != "Release ${{ github.ref_name }}" ]; then
              {
                echo "body<<CHANGELOG_EOF"
                echo "$TAG_MSG"
                echo "CHANGELOG_EOF"
              } >> $GITHUB_OUTPUT
            else
              echo "body=Release ${{ github.ref_name }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "body=Automatic build from commit ${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.prep.outputs.tag_name }}
          name: ${{ steps.prep.outputs.release_name }}
          body: |
            ${{ steps.changelog.outputs.body }}

            ---
            ðŸ“¦ **Packages:** Linux (amd64), Windows (amd64), macOS (Apple Silicon)
          draft: false
          prerelease: false
          files: release-assets/**/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
